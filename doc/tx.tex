\subsection{Fences and release/acquire synchronization}

We assume a subsets of release actions %$\Rel\subseteq\Act$
and acquire actions. % $\Acq\subseteq\Act$.
Reads, writes and touches in neither release nor acquire.

We say that the action $(\DR\aLoc\aVal)$ reads $\aLoc$ from $\aVal$.
Likewise, $(\DR\aLoc\aVal)$ writes $\aLoc$ to $\aVal$.  The touch action
$(\DT\aLoc)$ neither reads nor writes.  These notions lift to events; for example, $\aEv$
reads $\aLoc$ from $\aVal$ if $\labelling{\aEv}$ reads $\aLoc$ from $\aVal$.

Define $\freads(\aEv) = \freads(\aAct)$ when $\labelling(\aEv) = (\aForm \mid \aAct)$.
Likewise $\fwrites(\aEv)$.
\begin{definition}
  An \emph{rf-pomset} is a pomset together with a relation
  $\mathord{\RF} \subseteq \mathord{<}$.
\end{definition}
\begin{definition}
  An rf-pomset is $\aLoc$-closed if
  for $\aEv\in\Event$ with $\labelling(\aEv)=(\aForm \mid \aAct)$:
  \begin{itemize}
  \item $\aForm$ is independent of $\aLoc$, and
  \item if $\aEv$ reads $\aLoc$ at $\aVal$, then there is some
    $(\bEv,\aEv) \in \RF$ such that
    \begin{itemize}
    \item $\bEv$ writes $\aLoc$ at $\aVal$ and
    \item there is no $\bEv < \cEv < \aEv$ such that $\cEv$ writes $\aLoc$.
    \end{itemize}
  \end{itemize}
\end{definition}

Now the general definition of prefixing:

Let $(\phi \mid \aAct) \prefix \aPSS$ be the set $\aPSS'$ where
$\aPS'\in\aPSS'$ whenever there is $\aPS\in\aPSS$ such that:
\begin{itemize}
\item $\Event' = \Event \cup \{0\}$,
\item $\RF' = \RF$,
\item if $\bEv \le \aEv$ then $\bEv \le' \aEv$,
\item $\labelling'(0) = (\bForm \mid \aAct)$, where $\bForm$ implies $\aForm$, 
% \item if $\labelling(\aEv) = (\bForm \mid \bAct)$ and $\aAct$ sees nothing
%   then $\labelling'(\aEv) = (\bForm' \mid \bAct)$ and $\bForm'$ implies $\bForm$, and
\item if $\labelling(\aEv) = (\bForm \mid \bAct)$ then
  $\labelling'(\aEv) = (\bForm' \mid \bAct)$ and either $\bForm'$ implies
  $\bForm$ or
  $0 \le' \aEv$ and $\bForm'$ implies $\bForm[\vec{\aVal}/\vec{\aLoc}]$,
  where $\aAct$ sees $\vec{\aLoc}$ at $\vec{\aVal}$,
\item if $\labelling(\aEv) = (\bForm \mid \bAct)$ and $\bAct$ is a release then $0
  \le' \aEv$, and
\item if $\aAct$ is an acquire then $0 \le' \aEv$.  
\end{itemize}
The last two conditions are new.  The rest are the same as before, combining
read and write.   



Publication example:
\begin{alltt}
    var x; var f; x:=0; f:=0; fence; (x:=1; \REL{f}:=1;  ||  r:=\ACQ{f}; s:=x;)
\end{alltt}
We disallow the execution where \texttt{r==1} and \texttt{s!=1}

We model fences and release/acquire synchronization by introducing the
following actions:
\begin{itemize}
\item $(\DF)$ is both a release and an acquire action
\item $(\DWRel{\aLoc}{\aVal})$ is a release action, which writes $\aLoc$ at $\aVal$.
\item $(\DRAcq{\aLoc}{\aVal})$ is an acquire action, which reads $\aLoc$ at $\aVal$.
\end{itemize}
% \begin{itemize}
% \item Let $(\phi \mid \DWRel\aLoc\aVal) \prefix \aPSS$ be defined as
%   $(\phi \mid \DW\aLoc\aVal) \prefix \aPSS$.  
% \item Let $(\phi \mid \DRAcq\aLoc\aVal) \prefix \aPSS$ be defined as
%   $(\phi \mid \DR\aLoc\aVal) \prefix \aPSS$, requiring additionally that
%   $0 \le' \aEv$.
% Let $(\phi \mid \DF) \prefix \aPSS$ be the set $\aPSS'$ where $\aPS'\in\aPSS'$ whenever
% there is $\aPS\in\aPSS$ such that:
% \begin{itemize}
% \item $\Event' = \Event \cup \{0\}$,
% \item $\RF' = \RF$,
% \item if $\bEv \le \aEv$ then $\bEv \le' \aEv$,
% \item $0 \le' \aEv$, and
% \item $\labelling'(0) = (\aForm, \DF\aLoc\aVal)$, where $\bForm$ implies $\aForm$, and
% \item if $\labelling(\aEv) = (\bForm \mid \aAct)$ then $\labelling'(\aEv) = (\bForm \mid \aAct)$.
% \end{itemize}
% \end{itemize}
\begin{eqnarray*}
  \sem{\FENCE\SEMI \aCmd} & = & (\TRUE \mid \DF) \prefix \sem{\aCmd} \\
  \sem{\REL\aLoc\GETS\aExp\SEMI \aCmd} & = & \textstyle\bigcup_\aVal\; (\aExp=\aVal \mid \DWRel\aLoc\aVal) \prefix \sem{\aCmd}[\aExp/\aLoc] \\
  \sem{\aReg\GETS\ACQ\aLoc\SEMI \aCmd} & = & \textstyle\bigcup_\aVal\; (\TRUE \mid \DRAcq\aLoc\aVal) \prefix \sem{\aCmd}[\aLoc/\aReg] 
\end{eqnarray*}
There are no additional requirements for $\aLoc$-closure is.

\subsection{Transactions}

We present a model of weakly isolated transactions.  To get strong isolation,
we need to make $\DB$ record the reads, symmetrically to $\DC{}{}$; we also need
to require in parallel composition that any order in-to/out-of a
transactional event be lifted to the corresponding $\DB$/$\DC{}{}$

\begin{alltt}
  var x; var f; x:=0; f:=0; fence; 
     x:=1; (begin; f:=1; f:=2; end;) || (begin; r:=f; end; s:=x;)
\end{alltt}
$\END\SEMI \aCmd$ is sugar for $\IFCOMMITTHEN \aCmd \ELSE \aCmd$.

\begin{itemize}
\item $(\DB)$ is an acquire action
\item %$(\DCn{\aLoc}{\aVal})$
  $(\DC{\vec\aLoc}{\vec\aVal})$
  is a release action which writes $\vec\aLoc$ at $\vec\aVal$
\end{itemize}

\begin{eqnarray*}
  \sem{\BEGIN\SEMI \aCmd}
  & = & (\TRUE \mid \DB) \prefix \sem{\aCmd}
  \\
  \sem{\IFCOMMITTHEN \aCmd \ELSE \bCmd}
  & = & \textstyle\bigcup_{\vec\aVal,\,\aForm\,\text{implies}\,\vec\aLoc=\vec\aVal}\;
        ((\aForm \mid \DC{\vec\aLoc}{\vec\aVal}) \prefix (\aForm \mid \sem{\aCmd}))
        \sqcup  (\lnot\aForm \mid \sem{\bCmd})
\end{eqnarray*}

\begin{definition}
  An rf-pomset is transaction-closed if the $\DB$ and $\DC{}{}$ actions with
  satisfiable preconditions are totally ordered by $<$.
\end{definition}

For example, the semantics of
\begin{alltt}
  x:=1; begin; x:=2; end; y:=x;
\end{alltt}
includes
\[\begin{tikzpicture}[node distance=1em]
  \event{wx1}{\DW{x}{1}}{}
  \event{b}{\DB}{right=of wx1}
  \event{wx2}{\DW{x}{2}}{right=of b}
  \event{c}{\DC{x}{2}}{right=of wx2}
  \event{wy2}{\DW{y}{2}}{right=of c}
  \nonevent{wy1}{\DW{y}{1}}{below=of wy2}
  \po{b}{wx2}
  \po[bend right]{b}{wy1}
  \po[bend left]{b}{wy2}
  \po{wx2}{c}
  \po[bend left]{wx1}{c}
  %\po{rz0}{wy2}
\end{tikzpicture}\]
and
\[\begin{tikzpicture}[node distance=1em]
  \event{wx1}{\DW{x}{1}}{}
  \event{b}{\DB}{right=of wx1}
  \nonevent{wx2}{\DW{x}{2}}{right=of b}
  \nonevent{c}{\DC{x}{2}}{right=of wx2}
  \nonevent{wy2}{\DW{y}{2}}{right=of c}
  \event{wy1}{\DW{y}{1}}{below=of wy2}
  \po{b}{wx2}
  \po[bend right]{b}{wy1}
  \po[bend left]{b}{wy2}
  \po{wx2}{c}
  \po[bend left]{wx1}{c}
  %\po{rz0}{wy2}
\end{tikzpicture}\]


% Note: we could also include a transaction factory, and close the factory.
% \begin{alltt}
%   TransactionFactory T; var x; var f; x:=0; f:=0; fence; 
%      x:=1; (begin T; f:=1; f:=2; end T;) || (begin T; r:=f; end T; s:=x;)
% \end{alltt}

% Local Variables:
% TeX-master: "paper"
% End:
